
# <font color=green> myspringbatchproject üéØ </font>


<b>

#### üî• <font color=red> ATTENTION : il est obligatoire de toujours d√©marrer son projet spring batch avec une d√©pendance √† une base de donn√©es (m√™me m√©moire comme h2 si dans la mesure du possible) au risque d'avoir une exception lors de l'√©x√©cution du projet. Son r√¥le est de g√©rer l'√©tat des traitements batch , sauvegarder les m√©tadonn√©es d'ex√©cution : job lanc√©s , √©tapes termin√©es, tentatives, erreurs, red√©marrages, etc.
Elle est indispensable parce que :
- elle permet de reprendre un job l√† o√ª, il s'est arr√™t√© (red√©marrage)
- √©vite de relancer un job d√©j√† ex√©cut√© (gestion des identifiants d'ex√©cution)
- stocke les logs de traitements (dans les tables BATCH_JOB_EXECUTION, etc.)

Sans base de donn√©es :

- Impossible de suivre l'√©tat des jobs
- pas de reprise possible
- pas de fiabilit√© en production

üõë NB : Spring batch peut utiliser une bdd en m√©moire (tel H2) pour des tests ou prototypes, mais pas en prod.
</font>

---

### üìö <font color=green> √©tape 6 : Comprendre comment les m√©ta donn√©es des Job et de leurs steps sont stock√©es dans le SGBD utilis√© </font>

En Spring Batch, les m√©tadonn√©es des jobs et des steps sont stock√©es dans des tables relationnelles dans le SGBD configur√©, pas en tant que paires cl√©-valeur g√©n√©riques, mais plut√¥t dans une structure SQL normalis√©e.

‚úÖ <font color=orange> Comment les m√©tadonn√©es sont stock√©es ? </font>

Spring Batch cr√©e automatiquement un ensemble de tables sp√©cifiques pour suivre l‚Äô√©tat des jobs. Ces tables sont relationnelles (pas des paires cl√©/valeur au sens strict) et reli√©es entre elles par des cl√©s primaires/√©trang√®res.

üìÇ <font color=orange >Tables principales cr√©√©es par Spring Batch </font>

Voici les tables principales utilis√©es pour stocker les m√©tadonn√©es :

| Table                          | R√¥le                                                                      |
|--------------------------------|---------------------------------------------------------------------------|
| `BATCH_JOB_INSTANCE`           | Identifie chaque instance logique d‚Äôun job                                |
| `BATCH_JOB_EXECUTION`          | Enregistre chaque ex√©cution d‚Äôun job                                      |
| `BATCH_JOB_EXECUTION_PARAMS`   | Stocke les param√®tres d‚Äôun job (sous forme cl√©/valeur)                    |
| `BATCH_STEP_EXECUTION`         | Enregistre chaque ex√©cution d‚Äôun step                                     |
| `BATCH_STEP_EXECUTION_CONTEXT` | Contexte d‚Äôex√©cution d‚Äôun step (stock√© sous forme de hash map s√©rialis√©e) |
| `BATCH_JOB_EXECUTION_CONTEXT`  | Contexte global d‚Äôun job                                                  |


üîë <font color=orange> Ce qui est effectivement stock√© en cl√©/valeur : </font>

Les contextes d‚Äôex√©cution (ExecutionContext) sont stock√©s dans :

BATCH_JOB_EXECUTION_CONTEXT

BATCH_STEP_EXECUTION_CONTEXT

Ces champs contiennent une s√©rialisation d'une Map<String, Object> (typiquement une cha√Æne JSON ou un blob encod√©) ‚Äî c‚Äôest l√† qu'on trouve des paires cl√©/valeur.

üß† <font color=orange>Exemple concret</font>
Tu ex√©cutes un job ImportClientJob avec idClient=42.

Les donn√©es seront enregistr√©es comme suit :

BATCH_JOB_INSTANCE : une ligne pour ImportClientJob

BATCH_JOB_EXECUTION : une ligne pour l‚Äôex√©cution actuelle

BATCH_JOB_EXECUTION_PARAMS : cl√© = idClient, valeur = 42

BATCH_STEP_EXECUTION : une ligne pour chaque step ex√©cut√©

BATCH_STEP_EXECUTION_CONTEXT : des infos internes, comme read.count, commit.count, etc.

üß™ <font color=orange>Comment sont cr√©√©es ces tables ?</font>

Spring Batch fournit un script SQL (schema-*.sql) adapt√© √† chaque SGBD (MySQL, PostgreSQL, H2, etc.) dans le package :

    org.springframework.batch.core.schema

Tu peux l‚Äôex√©cuter manuellement ou le laisser Spring Boot le faire automatiquement si spring.batch.initialize-schema=always est activ√©.

üìå <font color=orange>En r√©sum√©</font>

Les m√©tadonn√©es des jobs sont stock√©es dans une base relationnelle via des tables bien d√©finies.

Les param√®tres et contextes d'ex√©cution sont les seuls stock√©s en paires cl√©/valeur s√©rialis√©es.

Cette structure permet la reprise, le suivi et l‚Äôaudit des traitements batch.

---

### üìö <font color=green> √©tape 7 : Configuration et utilisation de Mariadb √† la place de H2</font>

Comme expliqu√© un projet avec sSpring Batch ne peut se faire sans un SGBD.
Dans le cadre de ce projet, nous utiliserons MariaDB, pour nos tests.
Nous proc√©dons alors au remplacement de la d√©pendance maven de H2 √† MariaDB, et configurons l'acc√®s √† notre base de
donn√©es nomm√©e spring_batch, dans le fichier applications.properties.

L'utilisation d'un sgbd √† la place de la base de donn√©es m√©moire h2, nous permet de bien observer le cycle de vie d'une
instance de Job et de ses steps.

En effet, les tables suivantes sont cr√©√© :


| Table                          | R√¥le                                                                      |
|--------------------------------|---------------------------------------------------------------------------|
| `BATCH_JOB_INSTANCE`           | Identifie chaque instance logique d‚Äôun job                                |
| `BATCH_JOB_EXECUTION`          | Enregistre chaque ex√©cution d‚Äôun job                                      |
| `BATCH_JOB_EXECUTION_PARAMS`   | Stocke les param√®tres d‚Äôun job (sous forme cl√©/valeur)                    |
| `BATCH_STEP_EXECUTION`         | Enregistre chaque ex√©cution d‚Äôun step                                     |
| `BATCH_STEP_EXECUTION_CONTEXT` | Contexte d‚Äôex√©cution d‚Äôun step (stock√© sous forme de hash map s√©rialis√©e) |
| `BATCH_JOB_EXECUTION_CONTEXT`  | Contexte global d‚Äôun job                                                  |

Et √† chaque ex√©cution de projet Spring batch, on peut s'apercevoir que :

<font color=red> l'ex√©cution d'une instance de notre projet entra√Æne l'enregistrement des informations de notre du Job, 
  de Steps, de leurs param√®tres et de leur contexts dans les tables pr√©cit√©s. 
  Si le job est ex√©cut√© avec succ√®s, sa r√©ex√©cution 
  n'est pas possible et affichera un message d'alert dans les logs de spring batch. 
  De plus ce ne sont que les tables : BATCH_JOB_EXECUTION et BATCH_JOB_EXECUTION_CONTEXT qui auront de nouvelles lignes.
  Toutes les autres tables n'auront aucune nouvelles.

üî• Ce qui veut dire qu'une seule instance d'un JOB n'est ex√©cutable. 


---

### üìö <font color=green> √©tape 8 : Ex√©cution d'un m√™me JOB sous plusieurs instances </font>

Dans un projet spring batch, les JOB sont stock√©s dans la table BATCH_JOB_INSTANCE avec un id chacun.
De ce fait un m√™me JOB ne peut √™tre r√©ex√©cut√©. 
Afin d'ex√©cuter un m√™me JOB plusieurs fois, il faudrait le param√©trer au lancement de l'application :

- en passant le(s) param√®tres : <font color=yellow>run=nomParametre</font> au lancement via l'√©diteur de d√©veloppement 
- ou en ligne de commande 

Ceci entrainera une nouvelle instance du m√™me JOB chaque lancement √† cause des arguments.



</b>